{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.37.4.10188",
      "templateHash": "2908269455065785721"
    },
    "name": "Microsoft Graph Federated Identity Credentials",
    "description": "Creates and configures federated identity credentials for Azure AD applications",
    "owner": "Platform Team"
  },
  "parameters": {
    "applicationId": {
      "type": "string",
      "metadata": {
        "description": "Required. The application ID (object ID) of the parent application"
      }
    },
    "name": {
      "type": "string",
      "metadata": {
        "description": "Required. Name of the federated identity credential"
      }
    },
    "issuer": {
      "type": "string",
      "metadata": {
        "examples": [
          "https://token.actions.githubusercontent.com",
          "https://vstoken.dev.azure.com/{organization}",
          "https://accounts.google.com",
          "arn:aws:iam::{account}:oidc-provider/token.actions.githubusercontent.com"
        ],
        "description": "Required. The issuer of the external identity provider"
      }
    },
    "subject": {
      "type": "string",
      "metadata": {
        "examples": [
          "repo:owner/repository:ref:refs/heads/main",
          "repo:owner/repository:environment:production",
          "repo:owner/repository:pull_request"
        ],
        "description": "Required. The subject claim from the incoming token"
      }
    },
    "audiences": {
      "type": "array",
      "minLength": 1,
      "metadata": {
        "description": "Required. The audiences that can appear in the external token"
      }
    },
    "credentialDescription": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Optional. Description of the federated identity credential"
      }
    }
  },
  "variables": {
    "validatedAudiences": "[if(greater(length(parameters('audiences')), 0), parameters('audiences'), createArray('api://AzureADTokenExchange'))]"
  },
  "imports": {
    "microsoftGraphV1": {
      "provider": "MicrosoftGraph",
      "version": "1.0.0"
    }
  },
  "resources": {
    "federatedIdentityCredential": {
      "import": "microsoftGraphV1",
      "type": "Microsoft.Graph/applications/federatedIdentityCredentials@v1.0",
      "properties": {
        "name": "[format('{0}/federatedIdentityCredentials/{1}', parameters('applicationId'), parameters('name'))]",
        "audiences": "[variables('validatedAudiences')]",
        "description": "[if(not(empty(parameters('credentialDescription'))), parameters('credentialDescription'), null())]",
        "issuer": "[parameters('issuer')]",
        "subject": "[parameters('subject')]"
      },
      "metadata": {
        "description": "Microsoft Graph Federated Identity Credential"
      }
    }
  },
  "outputs": {
    "resourceId": {
      "type": "string",
      "metadata": {
        "description": "The resource ID of the federated identity credential"
      },
      "value": "[reference('federatedIdentityCredential').id]"
    },
    "name": {
      "type": "string",
      "metadata": {
        "description": "The name of the federated identity credential"
      },
      "value": "[parameters('name')]"
    },
    "issuer": {
      "type": "string",
      "metadata": {
        "description": "The issuer of the federated identity credential"
      },
      "value": "[parameters('issuer')]"
    },
    "subject": {
      "type": "string",
      "metadata": {
        "description": "The subject of the federated identity credential"
      },
      "value": "[parameters('subject')]"
    },
    "audiences": {
      "type": "array",
      "metadata": {
        "description": "The audiences of the federated identity credential"
      },
      "value": "[variables('validatedAudiences')]"
    },
    "credentialDescription": {
      "type": "string",
      "metadata": {
        "description": "The description of the federated identity credential"
      },
      "value": "[if(not(empty(parameters('credentialDescription'))), parameters('credentialDescription'), '')]"
    }
  }
}